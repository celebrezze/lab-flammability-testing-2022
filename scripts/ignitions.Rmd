---
title: "Ignitions"
author: "Joe Celebrezze"
date: "2024-01-27"
output: html_document
---

# Setup
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(here)
here = here::here
source(here("scripts", "source_code.R"))

source(here('scripts', 'mem.selection.function.R')) #this is where mem.selection(), mem.selection.table() and mallows.cp() functions are stored

flamm.df <- read.csv(here('data', 'processed-data', 'all_data.csv'))

library(DHARMa)
library(multcomp)
#install.packages('lsmeans')
library(lsmeans)
library(car)
```

# Data Wrangling
Basically, copying the mem.df from MEM.Rmd
```{r}
mem.df <- flamm.df %>% 
  unite('plant_id', c(species, plant), sep = '_', remove = F) %>% 
  select(species, thickness, lfm, leaf_area, LMA, sample_wt, leaf_mass_ratio,
         branching, mpa, ignition, fh, fd, temp_change, heat_flux_change, prop_ig,
         dw_flam_sample, ww_flam_sample, sample_density, branch_volume, start_temp,
         leaf_area, branch_height, stem_dmc, leaf_dmc, dmc, stem_sav, leaf_sav,
         dw_sppdev, plant_id) %>% 
  mutate(lfm = scale(lfm), mpa = scale(mpa), ww_flam_sample = scale(ww_flam_sample),
         dw_flam_sample = scale(dw_flam_sample), sample_density = scale(sample_density),
         LMA = scale(LMA), thickness = scale(thickness),
         leaf_area = scale(leaf_area), branching = scale(branching),
         leaf_mass_ratio = scale(leaf_mass_ratio), sample_wt = scale(sample_wt),
         start_temp = scale(start_temp), branch_volume = scale(branch_volume),
         fh = scale(fh), fd = scale(fd),
         temp_change = scale(temp_change), heat_flux_change = scale(heat_flux_change),
         leaf_area = scale(leaf_area), branch_height = scale(branch_height),
         stem_dmc = scale(stem_dmc), leaf_dmc = scale(leaf_dmc), dmc = scale(dmc),
         stem_sav = scale(stem_sav), leaf_sav= scale(leaf_sav),
         dw_sppdev= scale(dw_sppdev)) %>% 
  mutate(ignition_binary = as.numeric(ifelse(ignition == 'M', 0, ignition))) %>% 
  drop_na(lfm, LMA, sample_wt, leaf_mass_ratio, branching, mpa, start_temp, dmc, stem_sav, thickness, species) %>% 
  filter(species != 'HETARB', species != 'ARCDEN')

mem.df %>% 
  group_by(species) %>% 
  tally()

mem.rf.df <- mem.df %>% 
  select(ignition_binary, lfm, LMA, sample_wt, leaf_mass_ratio, branching, mpa, start_temp, dmc, branch_volume, stem_sav, leaf_sav, thickness, species) %>% 
  drop_na(ignition_binary, lfm, LMA, sample_wt, leaf_mass_ratio, branching, mpa, start_temp, dmc, branch_volume, stem_sav, leaf_sav, thickness, species)

mem.predictors.df <- mem.df %>% 
  select(lfm, LMA, sample_wt, leaf_mass_ratio, branching, mpa, start_temp, dmc, stem_sav, thickness, species) # species

mem.predictors.df.short <- mem.df %>% 
  select(lfm, sample_wt, branching, species) 
```

# Interspecific Differences
## Chi-squared Test
```{r}
prop.ig.df <- flamm.df %>% 
  select(species, ignition) %>% 
  mutate(ignition = ifelse(ignition == 1, 'ignited', 'non-ignited'))

table(prop.ig.df$species, prop.ig.df$ignition)
chisq.test(prop.ig.df$species, prop.ig.df$ignition)
```

## GLMM and Tukey-Kramer
Using binomial generalized mixed effects model w/ species as only fixed effect
```{r}
flamm.df <- flamm.df %>% 
  unite('plant_id', c(species, plant), sep = '_', remove = F) %>% 
  mutate(species = as.factor(species)) %>% 
  mutate(ignition_binary = as.numeric(ifelse(ignition == 'M', 0, ignition)))

# model structure
ig.spp.binomial2 <- glmmTMB(ignition_binary ~ species + (1|plant_id), family = binomial, data = flamm.df)

# method 1
ig.spp.bin.tukey <- emmeans(ig.spp.binomial2, pairwise ~ species, adjust = 'tukey')
summary(ig.spp.bin.tukey)

# method 2
lsm.ig.spp <- lsmeans(ig.spp.binomial2, c("species"))
summary(lsm.ig.spp)
cld(lsm.ig.spp, Letters=letters)
```

# Model Selection
GLMM
```{r}
ig.glmm.selection <- glmm.selection('ignition_binary', mem.predictors.df, mem.df, binomial, zero.inflation = '0')
ig.glmm.df <- ig.glmm.selection[[1]]
ig.glmm.list <- ig.glmm.selection[[2]]
```

## No species 
```{r}
m1 <- glmmTMB(ignition_binary ~ species + LMA + stem_sav + (1|plant_id), family = binomial, data = mem.df)
AIC(m1) # higher

m2 <- glmmTMB(ignition_binary ~ species + lfm + LMA + stem_sav + (1|plant_id), family = binomial, data = mem.df)
AIC(m2) # higher

m3 <- glmmTMB(ignition_binary ~ species + LMA + stem_sav + leaf_mass_ratio + (1|plant_id), family = binomial, data = mem.df)
AIC(m3) # higher

m4 <- glmmTMB(ignition_binary ~ species + LMA + stem_sav + thickness + (1|plant_id), family = binomial, data = mem.df)
AIC(m4) # higher

m5 <- glmmTMB(ignition_binary ~ species + LMA + stem_sav + thickness + leaf_mass_ratio + (1|plant_id), family = binomial, data = mem.df)
AIC(m5) # higher

m6 <- glmmTMB(ignition_binary ~ species + branching + dmc + lfm + thickness + LMA + stem_sav + (1|plant_id), family = binomial, data = mem.df)
AIC(m6) # higher

m7 <- glmmTMB(ignition_binary ~ species + branching + lfm + LMA + stem_sav + (1|plant_id), family = binomial, data = mem.df)
AIC(m7) # higher

m8 <- glmmTMB(ignition_binary ~ species + dmc + lfm + thickness + LMA + stem_sav + (1|plant_id), family = binomial, data = mem.df)
AIC(m8) # higher

m9 <- glmmTMB(ignition_binary ~ species + LMA + sample_wt + stem_sav + (1|plant_id), family = binomial, data = mem.df)
AIC(m9) # higher

m10 <- glmmTMB(ignition_binary ~ species + lfm + thickness + LMA + stem_sav + (1|plant_id), family = binomial, data = mem.df)
AIC(m10) # higher

m11 <- glmmTMB(ignition_binary ~ species + dmc + LMA + stem_sav + (1|plant_id), family = binomial, data = mem.df)
AIC(m11) # higher

m12 <- glmmTMB(ignition_binary ~ species + dmc + thickness + LMA + stem_sav + (1|plant_id), family = binomial, data = mem.df)
AIC(m12) # higher

m13 <- glmmTMB(ignition_binary ~ species + branching + LMA + stem_sav + (1|plant_id), family = binomial, data = mem.df)
AIC(m13) # higher

m14 <- glmmTMB(ignition_binary ~ species + dmc + lfm + LMA + stem_sav + (1|plant_id), family = binomial, data = mem.df)
AIC(m14) # higher

m15 <- glmmTMB(ignition_binary ~ species + branching + LMA + stem_sav + (1|plant_id), family = binomial, data = mem.df)
AIC(m15) # higher

m16 <- glmmTMB(ignition_binary ~ species + branching + lfm + thickness + LMA + stem_sav + (1|plant_id), family = binomial, data = mem.df)
AIC(m16) # higher

m17 <- glmmTMB(ignition_binary ~ species + start_temp + LMA + stem_sav + (1|plant_id), family = binomial, data = mem.df)
AIC(m17) # higher

m18 <- glmmTMB(ignition_binary ~ species + mpa + LMA + stem_sav + (1|plant_id), family = binomial, data = mem.df)
AIC(m18) # higher

m19 <- glmmTMB(ignition_binary ~ species + branching + thickness + (1|plant_id), family = binomial, data = mem.df)
AIC(m19) # higher

m20 <- glmmTMB(ignition_binary ~ species + thickness + (1|plant_id), family = binomial, data = mem.df)
AIC(m20) # higher

m21 <- glmmTMB(ignition_binary ~ species + branching + (1|plant_id), family = binomial, data = mem.df)
AIC(m21) # higher
```

## Testing for Interactions
### Function
```{r}
# NOTE: y.var must be a character vector
glmm.int.selection <- function(y.var, predictors, df, mod.family, zero.inflation, rem.str = '(1|plant_id)'){
# FIRST: List models
# Generate all possible combinations of two predictors for interaction
interaction_combinations <- combn(predictors, 2, simplify = FALSE)

# Create an empty list to store model results
mod.list <- list()

# Loop through the interaction combinations
for (combo in interaction_combinations) {
  # Create the formula for the model (e.g., outcome ~ predictor1 * predictor2)
  formula <- as.formula(paste(y.var, "~", paste(combo, collapse = "*"), "+", rem.str))
  
  # Fit the mixed-effects model
  model <- glmmTMB(formula, data = df, family = mod.family, ziformula = as.formula(paste0('~', zero.inflation, sep = '')))
  
  # Store the model result in the list
  mod.list[[paste(combo, collapse = "_")]] <- model
}
  
  # CREATE DATAFRAME
  model.df <- data.frame(model.id = c(1:length(mod.list)),
                         call = c(rep(NA, length(mod.list))),
                         multicollinearity = c(rep(NA, length(mod.list))),
                         AIC = c(rep(NA, length(mod.list))),
                         BIC = c(rep(NA, length(mod.list))),
                         R2_marg = c(rep(NA, length(mod.list))),
                         R2_cond = c(rep(NA, length(mod.list))))
  
  # SECOND: FLAG ANY MODELS THAT BREAK MULTICOLINEARITY ASSUMPTIONS
#  for(i in 1:length(mod.list)){
#    vif.df <- multicollinearity(mod.list[[i]])
#    ifelse(max(vif.df$VIF) > 5, model.df$multicollinearity[i] <- 'yes', 
#           model.df$multicollinearity[i] <- 'no')
#  }
  
#  for(i in 1:length(mod.list)){
#    if(model.df$multicollinearity[i] == 'yes'){
#      mod.list[[i]] <- NA
#    }}
  
  # THIRD: CALCULATE AIC, BIC, MALLOWS CP
  for(i in 1:length(mod.list)) {
#    if(model.df$multicollinearity[i] == 'yes')
 #   {model.df[i, 3:6] <- NA}
#    else{
      model.df$call[i] <- paste0(mod.list[[i]]$call$formula)[3]
      model.df$AIC[i] <- AIC(mod.list[[i]])
      model.df$BIC[i] <- BIC(mod.list[[i]])
      model.df$R2_marg[i] <- as.numeric(r2_nakagawa(mod.list[[i]])$R2_marginal)
      model.df$R2_cond[i] <- as.numeric(r2_nakagawa(mod.list[[i]])$R2_conditional)
    }
# }
  output <- list(model.df, mod.list)
  return(output)
}
```

### Applying Function
```{r}
# Defining predictors we're interested in as a character vector
predictors <- c('lfm', 'LMA', 'sample_wt', 'leaf_mass_ratio', 'branching', 'mpa', 'start_temp', 'dmc', 'stem_sav', 'thickness', 'species')

glmm.ig.int.selection <- glmm.int.selection('ignition_binary', predictors, mem.df, binomial, zero.inflation = '0')
ig.int.glmm.df <- glmm.ig.int.selection[[1]]
ig.int.glmm.list <- glmm.ig.int.selection[[2]]
```

### Adding Predictors
```{r}
ig.int.glmm.list[[56]] <- glmmTMB(ignition_binary ~ species*mpa + thickness + (1|plant_id), family = binomial, data = mem.df)
AIC(ig.int.glmm.list[[56]])

ig.int.glmm.list[[57]] <- glmmTMB(ignition_binary ~ species*mpa + branching + (1|plant_id), family = binomial, data = mem.df)
AIC(ig.int.glmm.list[[57]])
BIC(ig.int.glmm.list[[57]])
r2_nakagawa(ig.int.glmm.list[[57]])

ig.int.glmm.list[[58]] <- glmmTMB(ignition_binary ~ species*mpa + thickness + branching + (1|plant_id), family = binomial, data = mem.df)
AIC(ig.int.glmm.list[[58]])
BIC(ig.int.glmm.list[[58]])
r2_nakagawa(ig.int.glmm.list[[58]])

ig.int.glmm.list[[59]] <- glmmTMB(ignition_binary ~ species*thickness + mpa + (1|plant_id), family = binomial, data = mem.df)
AIC(ig.int.glmm.list[[59]])

ig.int.glmm.list[[60]] <- glmmTMB(ignition_binary ~ species*thickness + branching + (1|plant_id), family = binomial, data = mem.df)
AIC(ig.int.glmm.list[[60]])

ig.int.glmm.list[[61]] <- glmmTMB(ignition_binary ~ species*thickness + mpa + branching + (1|plant_id), family = binomial, data = mem.df)
AIC(ig.int.glmm.list[[61]])

ig.int.glmm.list[[62]] <- glmmTMB(ignition_binary ~ species*LMA + thickness + (1|plant_id), family = binomial, data = mem.df)
AIC(ig.int.glmm.list[[62]])

ig.int.glmm.list[[63]] <- glmmTMB(ignition_binary ~ species*LMA + branching + (1|plant_id), family = binomial, data = mem.df)
AIC(ig.int.glmm.list[[63]])

ig.int.glmm.list[[64]] <- glmmTMB(ignition_binary ~ species*LMA + thickness + branching + (1|plant_id), family = binomial, data = mem.df)
AIC(ig.int.glmm.list[[64]])
```

### Diagnostics
```{r}
simulated <- simulateResiduals(fittedModel = ig.int.glmm.list[[57]], n = 1000)
plot(simulated) # looks good
testZeroInflation(simulated) # looks good
testUniformity(simulated) # looks good
testDispersion(simulated) # looks good
```

### Predicted Values
```{r}
mem.df$predicted_ig <- predict(ig.int.glmm.list[[58]], mem.df)

mem.df %>% 
  mutate(predicted_ig = ifelse(predicted_ig < 0, 0, 1)) %>% 
ggplot(aes(x = as.factor(ignition_binary), y = predicted_ig)) +
  geom_jitter(width = 0.2, height = 0.15)

mem.df %>% 
  ggplot(aes(x = mpa, y = ignition_binary, color = species)) +
    geom_point() +
    geom_smooth(method = 'lm', se = F) +
    theme_bw()

flamm.df %>% 
  filter(species != 'IRIDOU', species != 'ARCDEN', species != 'HETARB') %>% 
  ggplot(aes(y = mpa, color = as.factor(ignition_binary), x = species)) +
    geom_boxplot() +
    labs(x = 'Species', y = 'Water Potential (-MPa)', color = 'Ignition') +
    theme_bw() +
    theme(axis.title = element_text(size = 15, face = 'bold'),
          legend.title = element_text(size = 15, face = 'bold'),
          legend.position = c(0.85, 0.85))

summary(ig.int.glmm.list[[57]])
```


```{r}
library(DHARMa)
library(multcomp)
install.packages('lsmeans')
library(lsmeans)
library(car)

Anova(ig.glmm.list[[1]])

lsm.ig.glmm <- lsmeans(ig.glmm.list[[1]], c("species"))
cld(lsm.ig.glmm, Letters=letters)
```


# Regressions
```{r}
mem.df %>% 
  pivot_longer(cols = c('leaf_sav', 'stem_sav', 'LMA'), names_to = 'predictor', values_to = 'value') %>% 
  ggplot(aes(x = value, y = ignition_binary, color = species)) +
    geom_point() +
    geom_smooth(method = 'binomial') +
    facet_wrap(~predictor) +
    theme_bw()
```

# Random Forest Model
## Basic
```{r}
library(ranger)

ig.rf <- ranger(ignition_binary ~ ., data = mem.rf.df, importance = 'impurity')

ig.rf.varimp <- as.data.frame(ig.rf$variable.importance)
ig.rf.varimp$variable <- rownames(ig.rf.varimp)
ig.rf.varimp <- ig.rf.varimp %>% 
  rename(varimp = `ig.rf$variable.importance`)
ig.rf.varimp$variable <- reorder(ig.rf.varimp$variable, desc(ig.rf.varimp$varimp), FUN = mean)

ig.rf.varimp %>% 
  ggplot() +
    geom_linerange(aes(x = variable, ymax = varimp, ymin = 0), linewidth = 10) +
    labs(x = 'Variable', y = 'Variable Importance') +
    theme_bw() +
    theme(axis.title = element_text(face = 'bold', size = 16),
        axis.text = element_text(size = 13))

# Predictions
## Mean values for predictors
spp.means <- mem.df %>% 
  group_by(species) %>% 
  summarise(lfm = mean(lfm), LMA = mean(LMA), sample_wt = mean(sample_wt), leaf_mass_ratio = mean(leaf_mass_ratio), branching = mean(branching), mpa = mean(mpa), start_temp = mean(start_temp), dmc = mean(dmc), branch_volume = mean(branch_volume), stem_sav = mean(stem_sav), leaf_sav = mean(leaf_sav), thickness = mean(thickness))

spp.means$predicted_ig <- predict(ig.rf, data = spp.means)$predictions

## All predictors = 0, only using species to predict
spp.only <- mem.df %>% 
  group_by(species) %>% 
  tally() %>% 
  mutate(lfm = 0, LMA = 0, sample_wt = 0, leaf_mass_ratio = 0, branching = 0, mpa = 0, start_temp = 0, dmc = 0, branch_volume = 0, stem_sav = 0, leaf_sav = 0, thickness = 0)

spp.only$predicted_ig <- predict(ig.rf, data = spp.only)$predictions
```

## Probability
```{r}
ig.prob.rf <- ranger(ignition_binary ~ ., data = mem.rf.df, probability = T, importance = 'impurity')

# Variable importance
ig.rf.varimp <- as.data.frame(ig.prob.rf$variable.importance)
ig.rf.varimp$variable <- rownames(ig.rf.varimp)
ig.rf.varimp <- ig.rf.varimp %>% 
  rename(varimp = `ig.prob.rf$variable.importance`)
ig.rf.varimp$variable <- reorder(ig.rf.varimp$variable, desc(ig.rf.varimp$varimp), FUN = mean)

ig.rf.varimp %>% 
  ggplot() +
    geom_linerange(aes(x = variable, ymax = varimp, ymin = 0), linewidth = 10) +
    labs(x = 'Variable', y = 'Variable Importance') +
    theme_bw() +
    theme(axis.title = element_text(face = 'bold', size = 16),
        axis.text = element_text(size = 13))
```

